name: CI

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
      - master

jobs:
  pre-commit:
    name: Format + lint code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - uses: pre-commit/action@v3.0.0
        with:
          extra_args: --hook-stage manual --all-files

  checks:
    name: Run tests for Python ${{ matrix.python-version }} on ${{ matrix.runs-on }}
    runs-on: ${{ matrix.runs-on }}
    needs: [pre-commit]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.12", "3.13"]
        runs-on: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install package
        run: python -m pip install .[dev]

      - name: Test package
        run: >-
          python -m pytest -ra --cov --cov-report=xml --cov-report=term
          --durations=20

      - name: Upload coverage report
        uses: codecov/codecov-action@v3.1.4

  integration:
    name: Integration tests - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: [pre-commit]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.12"]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install package
        run: python -m pip install .

      - name: Test import
        run: |
          python -c "import nres; print(f'nres version: {nres.__version__}')"
          python -c "import nres; print('Available modules:', dir(nres))"

      - name: Test basic functionality
        run: |
          python -c "
          import nres
          import numpy as np

          # Test cross-section creation
          Si = nres.CrossSection('Silicon')
          print('✓ Cross-section created')

          # Test basic data structure
          data = nres.Data()
          print('✓ Data object created')

          # Test model creation
          model = nres.TransmissionModel(Si)
          print('✓ TransmissionModel created')

          print('All basic imports and instantiations successful!')
          "

      - name: Test grouped data feature (v0.4)
        run: |
          python -c "
          import nres
          import numpy as np
          import pandas as pd

          # Test grouped data loading
          tof = np.arange(1, 101)
          trans_2d = np.random.rand(10, 100) * 0.9 + 0.05
          err_2d = trans_2d * 0.05

          grouped_data = nres.Data.from_grouped(
              tof=tof,
              trans=trans_2d,
              err=err_2d,
              L=10.0,
              tstep=1e-6
          )

          print(f'✓ Grouped data created with shape: {grouped_data.grouped_trans.shape}')
          print('Grouped data feature working!')
          "

      - name: Test rebinning feature (v0.4)
        run: |
          python -c "
          import nres
          import numpy as np
          import pandas as pd

          # Create test data
          tof = np.arange(1, 1001)
          signal_counts = np.random.poisson(200, 1000).astype(float)
          openbeam_counts = np.random.poisson(400, 1000).astype(float)

          signal_df = pd.DataFrame({
              'tof': tof,
              'counts': signal_counts,
              'err': np.sqrt(signal_counts)
          })

          openbeam_df = pd.DataFrame({
              'tof': tof,
              'counts': openbeam_counts,
              'err': np.sqrt(openbeam_counts)
          })

          data = nres.Data()
          data.signal = signal_df
          data.openbeam = openbeam_df
          data.L = 10.0
          data.tstep = 1e-6
          data.table = pd.DataFrame({
              'energy': tof,
              'trans': signal_counts / openbeam_counts,
              'err': 0.01 * np.ones_like(tof)
          })

          # Test rebinning
          rebinned = data.rebin(n=2)
          print(f'✓ Rebinned from {len(data.table)} to {len(rebinned.table)} bins')
          print('Rebinning feature working!')
          "
