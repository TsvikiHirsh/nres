name: CI

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
      - master

jobs:
  pre-commit:
    name: Format + lint code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - uses: pre-commit/action@v3.0.0
        with:
          extra_args: --hook-stage manual --all-files

  checks:
    name: Run tests for Python ${{ matrix.python-version }} on ${{ matrix.runs-on }}
    runs-on: ${{ matrix.runs-on }}
    needs: [pre-commit]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.12", "3.13"]
        runs-on: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install package
        run: python -m pip install .[dev]

      - name: Test package
        run: >-
          python -m pytest -ra --cov --cov-report=xml --cov-report=term
          --durations=20

      - name: Upload coverage report
        uses: codecov/codecov-action@v3.1.4

  integration:
    name: Integration tests - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: [pre-commit]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.12"]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install package
        run: python -m pip install .

      - name: Test import
        run: |
          python -c "import nres; print(f'nres version: {nres.__version__}')"
          python -c "import nres; print('Available modules:', dir(nres))"

      - name: Test basic functionality
        run: |
          python -c "
          import nres
          import numpy as np

          # Test cross-section creation
          Si = nres.CrossSection('Silicon')
          print('✓ Cross-section created')

          # Test basic data structure
          data = nres.Data()
          print('✓ Data object created')

          # Test model creation
          model = nres.TransmissionModel(Si)
          print('✓ TransmissionModel created')

          print('All basic imports and instantiations successful!')
          "

      - name: Test grouped data feature (v0.4)
        run: |
          python -c "
          import nres
          import numpy as np
          import pandas as pd

          # Test grouped data loading
          tof = np.arange(1, 101)
          trans_2d = np.random.rand(10, 100) * 0.9 + 0.05
          err_2d = trans_2d * 0.05

          grouped_data = nres.Data.from_grouped_arrays(
              tof=tof,
              trans=trans_2d,
              err=err_2d,
              L=10.0,
              tstep=1e-6
          )

          print(f'✓ Grouped data created with shape: {grouped_data.grouped_trans.shape}')
          print('Grouped data feature working!')
          "

      - name: Test rebinning feature (v0.4)
        run: |
          python -c "
          import nres
          import numpy as np
          import tempfile
          import os

          # Create temporary files for testing
          tmpdir = tempfile.mkdtemp()

          tof = np.arange(1, 1001, dtype=float)
          signal_counts = np.random.poisson(200, 1000)
          openbeam_counts = np.random.poisson(400, 1000)

          signal_file = os.path.join(tmpdir, 'signal.csv')
          openbeam_file = os.path.join(tmpdir, 'openbeam.csv')

          # Write CSV files
          with open(signal_file, 'w') as f:
              f.write('tof,counts,err\n')
              for t, c in zip(tof, signal_counts):
                  f.write(f'{t},{c},{np.sqrt(c)}\n')

          with open(openbeam_file, 'w') as f:
              f.write('tof,counts,err\n')
              for t, c in zip(tof, openbeam_counts):
                  f.write(f'{t},{c},{np.sqrt(c)}\n')

          # Load data properly using from_counts
          data = nres.Data.from_counts(
              signal_file, openbeam_file,
              L=10.0, tstep=1e-6, verbosity=0
          )

          # Test rebinning
          rebinned = data.rebin(n=2)
          print(f'✓ Rebinned from {len(data.table)} to {len(rebinned.table)} bins')

          # Cleanup
          import shutil
          shutil.rmtree(tmpdir)

          print('Rebinning feature working!')
          "
